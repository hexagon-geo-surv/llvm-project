// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 6
// RUN: %clang_cc1 -fsanitize=alloc-token -triple x86_64-linux-gnu -emit-llvm -disable-llvm-passes %s -o - | FileCheck %s

typedef __typeof(sizeof(int)) size_t;

void *aligned_alloc(size_t alignment, size_t size) __attribute__((malloc));
void *malloc(size_t size) __attribute__((malloc));
void *calloc(size_t num, size_t size) __attribute__((malloc));
void *realloc(void *ptr, size_t size) __attribute__((malloc));
void *reallocarray(void *ptr, size_t nmemb, size_t size) __attribute__((malloc));
void *memalign(size_t alignment, size_t size) __attribute__((malloc));
void *valloc(size_t size) __attribute__((malloc));
void *pvalloc(size_t size) __attribute__((malloc));
int posix_memalign(void **memptr, size_t alignment, size_t size);

void *sink;

// CHECK-LABEL: define dso_local void @test_malloc_like(
// CHECK-SAME: ) #[[ATTR0:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[CALL:%.*]] = call noalias ptr @malloc(i64 noundef 4) #[[ATTR5:[0-9]+]], !alloc_token [[META2:![0-9]+]]
// CHECK-NEXT:    store ptr [[CALL]], ptr @sink, align 8
// CHECK-NEXT:    [[CALL1:%.*]] = call noalias ptr @calloc(i64 noundef 3, i64 noundef 4) #[[ATTR6:[0-9]+]], !alloc_token [[META2]]
// CHECK-NEXT:    store ptr [[CALL1]], ptr @sink, align 8
// CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr @sink, align 8
// CHECK-NEXT:    [[CALL2:%.*]] = call noalias ptr @realloc(ptr noundef [[TMP0]], i64 noundef 8) #[[ATTR7:[0-9]+]], !alloc_token [[META3:![0-9]+]]
// CHECK-NEXT:    store ptr [[CALL2]], ptr @sink, align 8
// CHECK-NEXT:    [[TMP1:%.*]] = load ptr, ptr @sink, align 8
// CHECK-NEXT:    [[CALL3:%.*]] = call noalias ptr @reallocarray(ptr noundef [[TMP1]], i64 noundef 5, i64 noundef 8), !alloc_token [[META3]]
// CHECK-NEXT:    store ptr [[CALL3]], ptr @sink, align 8
// CHECK-NEXT:    [[CALL4:%.*]] = call noalias align 128 ptr @aligned_alloc(i64 noundef 128, i64 noundef 4) #[[ATTR7]], !alloc_token [[META2]]
// CHECK-NEXT:    store ptr [[CALL4]], ptr @sink, align 8
// CHECK-NEXT:    [[CALL5:%.*]] = call noalias align 16 ptr @memalign(i64 noundef 16, i64 noundef 4) #[[ATTR7]], !alloc_token [[META2]]
// CHECK-NEXT:    store ptr [[CALL5]], ptr @sink, align 8
// CHECK-NEXT:    [[CALL6:%.*]] = call noalias ptr @valloc(i64 noundef 4), !alloc_token [[META2]]
// CHECK-NEXT:    store ptr [[CALL6]], ptr @sink, align 8
// CHECK-NEXT:    [[CALL7:%.*]] = call noalias ptr @pvalloc(i64 noundef 4), !alloc_token [[META2]]
// CHECK-NEXT:    store ptr [[CALL7]], ptr @sink, align 8
// CHECK-NEXT:    [[CALL8:%.*]] = call i32 @posix_memalign(ptr noundef @sink, i64 noundef 64, i64 noundef 4)
// CHECK-NEXT:    ret void
//
void test_malloc_like() {
  sink = malloc(sizeof(int));
  sink = calloc(3, sizeof(int));
  sink = realloc(sink, sizeof(long));
  sink = reallocarray(sink, 5, sizeof(long));
  sink = aligned_alloc(128, sizeof(int));
  sink = memalign(16, sizeof(int));
  sink = valloc(sizeof(int));
  sink = pvalloc(sizeof(int));
  posix_memalign(&sink, 64, sizeof(int)); // FIXME: support posix_memalign
}
//.
// CHECK: [[META2]] = !{!"int", i1 false}
// CHECK: [[META3]] = !{!"long", i1 false}
//.
